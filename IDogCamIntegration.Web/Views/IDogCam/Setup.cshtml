@model KCBase.IDogCam.Models.CameraSetupViewModel
@{ViewBag.Title="iDogCam Setup";Layout="~/Views/Shared/_Layout.cshtml";}
<div class="idogcam-setup">
    <div class="header-section"><h2>iDogCam Camera Setup</h2><p class="description">Configure your iDogCam integration settings and camera assignments.</p></div>
    @if(!string.IsNullOrEmpty(ViewBag.ErrorMessage as string)){<div class="alert alert-danger">@ViewBag.ErrorMessage</div>}
    <div class="credentials-section">
        <h3>API Credentials</h3>
        @using(Ajax.BeginForm("SaveCredentials","IDogCam",new AjaxOptions{HttpMethod="POST",OnSuccess="onCredentialsSaved",OnFailure="onCredentialsError"},new {@class="credentials-form"})){
            <div class="form-row">
                <div class="form-group">@Html.LabelFor(m=>m.Credentials.ApiKey,"API Key")@Html.TextBoxFor(m=>m.Credentials.ApiKey,new {@class="form-control",placeholder="Your iDogCam API Key"})@Html.ValidationMessageFor(m=>m.Credentials.ApiKey,"",new {@class="field-validation-error"})</div>
                <div class="form-group">@Html.LabelFor(m=>m.Credentials.KennelId,"Kennel ID")@Html.TextBoxFor(m=>m.Credentials.KennelId,new {@class="form-control",placeholder="Your Kennel ID"})@Html.ValidationMessageFor(m=>m.Credentials.KennelId,"",new {@class="field-validation-error"})</div>
                <div class="form-group">@Html.LabelFor(m=>m.Credentials.ErpCode,"ERP Code")@Html.TextBoxFor(m=>m.Credentials.ErpCode,new {@class="form-control",placeholder="Your ERP Code"})@Html.ValidationMessageFor(m=>m.Credentials.ErpCode,"",new {@class="field-validation-error"})</div>
                <div class="form-group"><button type="submit" class="btn btn-primary">Test & Save Credentials</button></div>
            </div>
        }
        <div id="credentials-status" class="status-message"></div>
    </div>

    <div class="camera-config-section">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item"><a class="nav-link active" id="run-cameras-tab" data-toggle="tab" href="#run-cameras" role="tab">Run Cameras</a></li>
            <li class="nav-item"><a class="nav-link" id="room-cameras-tab" data-toggle="tab" href="#room-cameras" role="tab">Room/Area Cameras</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="run-cameras" role="tabpanel">
                <h4>Run Camera Configuration</h4><p>Link individual dog runs/cages to specific cameras.</p>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead><tr><th>Run</th><th>Camera</th><th>Other Service Link</th><th>Enabled for Client?</th><th>Actions</th></tr></thead>
                        <tbody id="run-cameras-table">
                            @foreach(var run in Model.AvailableRuns){var existingConfig=Model.RunCameras.FirstOrDefault(rc=>rc.RunId==run.Id);
                            <tr data-run-id="@run.Id"><td><strong>@run.Name</strong></td>
                            <td>@Html.DropDownList("CameraId_"+run.Id,new SelectList(Model.AvailableCameras,"Id","Title",existingConfig?.CameraId),"Select Camera",new {@class="form-control camera-select"})</td>
                            <td>@Html.DropDownList("ServiceLink_"+run.Id,new SelectList(Model.AvailableServices,"ServiceName","ServiceName",existingConfig?.OtherServiceLink),"Select Service",new {@class="form-control"})</td>
                            <td>@Html.CheckBox("EnabledForClient_"+run.Id,existingConfig?.EnabledForClient??false,new {@class="form-check-input"})</td>
                            <td><button type="button" class="btn btn-success btn-sm save-run-camera" data-run-id="@run.Id">Save</button>
                            @if(!string.IsNullOrEmpty(existingConfig?.CameraId)){<a href="@Url.Action("Viewer","IDogCam",new{cameraId=existingConfig.CameraId,employee=true})" class="btn btn-info btn-sm" target="_blank">View</a>}
                            </td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="room-cameras" role="tabpanel">
                <h4>Room/Area Camera Configuration</h4><p>Configure cameras for shared areas like play yards, pools, etc.</p>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead><tr><th>Room Name</th><th>Display Name for Client</th><th>Camera</th><th>Service Links</th><th>Show Type</th><th>Times Available</th><th>Actions</th></tr></thead>
                        <tbody>
                            @foreach(var room in Model.AvailableRooms){var existingConfig=Model.RoomCameras.FirstOrDefault(rc=>rc.RoomId==room.Id);
                            <tr data-room-id="@room.Id">
                                <td><strong>@room.Name</strong></td>
                                <td>@Html.TextBox("DisplayName_"+room.Id,existingConfig?.DisplayNameForClient??room.Name,new {@class="form-control",placeholder="Display name for clients"})</td>
                                <td>@Html.DropDownList("RoomCameraId_"+room.Id,new SelectList(Model.AvailableCameras,"Id","Title",existingConfig?.CameraId),"Select Camera",new {@class="form-control camera-select"})</td>
                                <td><div class="service-links"><label>Other Service:</label>@Html.DropDownList("RoomServiceLink_"+room.Id,new SelectList(Model.AvailableServices,"ServiceName","ServiceName",existingConfig?.OtherServiceLink),"Select Service",new {@class="form-control form-control-sm"})<label>Exercise:</label>@Html.DropDownList("RoomExerciseLink_"+room.Id,new SelectList(Model.AvailableServices.Where(s=>s.ServiceName.Contains("Play")||s.ServiceName.Contains("Walk")||s.ServiceName.Contains("Swimming")),"ServiceName","ServiceName",existingConfig?.ExerciseServiceLink),"Select Exercise",new {@class="form-control form-control-sm"})</div></td>
                                <td>@Html.DropDownListFor(m=>existingConfig.ShowType,new SelectList(Enum.GetValues(typeof(KCBase.IDogCam.Models.ShowType)).Cast<KCBase.IDogCam.Models.ShowType>().Select(e=>new{Value=(int)e,Text=e.ToString().Replace("DuringServiceTime","During Service Time").Replace("DuringEntireStayIfHasService","During Entire Stay If Has Service").Replace("AnyPetCheckedIn","Any Pet Checked In")}),"Value","Text",(int)(existingConfig?.ShowType??KCBase.IDogCam.Models.ShowType.DuringServiceTime)),"Select Show Type",new {@class="form-control",@name="ShowType_"+room.Id})</td>
                                <td>@Html.TextBox("AvailableTimes_"+room.Id,existingConfig?.AvailableTimes!=null?string.Join(", ",existingConfig.AvailableTimes.Select(t=>t.ToString())):"",new {@class="form-control",placeholder="8:00am-10:00am, 3:00pm-5:00pm"})</td>
                                <td><button type="button" class="btn btn-success btn-sm save-room-camera" data-room-id="@room.Id">Save</button>@if(!string.IsNullOrEmpty(existingConfig?.CameraId)){<a href="@Url.Action("Viewer","IDogCam",new{cameraId=existingConfig.CameraId})" class="btn btn-info btn-sm" target="_blank">View</a>}</td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.unobtrusive-ajax/3.2.6/jquery.unobtrusive-ajax.min.js"></script>
<script>
$(document).ready(function(){
    $('.save-run-camera').click(function () {
        var runId = $(this).data('run-id');
        var row = $('tr[data-run-id="' + runId + '"]');
        var data = { RunId: runId, RunName: row.find('td:first strong').text(), CameraId: row.find('select[name="CameraId_' + runId + '"]').val(), OtherServiceLink: row.find('select[name="ServiceLink_' + runId + '"]').val(), EnabledForClient: row.find('input[name="EnabledForClient_' + runId + '"]').is(':checked') };
        $.post('@Url.Action("SaveRunCamera","IDogCam")', data).done(function (response) {
            if (response.success) {
                showMessage('success', response.message);
                setTimeout(function () { location.reload(); }, 1000);
            }
            else {
                showMessage('error', response.message);
            }
        }).fail(function () {
            showMessage('error', 'Failed to save run camera configuration');
        });
    });
    $('.save-room-camera').click(function () {
        var roomId = $(this).data('room-id');
        var row = $('tr[data-room-id="' + roomId + '"]');
        var data = { RoomId: roomId, RoomName: row.find('td:first strong').text(), DisplayNameForClient: row.find('input[name="DisplayName_' + roomId + '"]').val(), CameraId: row.find('select[name="RoomCameraId_' + roomId + '"]').val(), OtherServiceLink: row.find('select[name="RoomServiceLink_' + roomId + '"]').val(), ExerciseServiceLink: row.find('select[name="RoomExerciseLink_' + roomId + '"]').val(), ShowType: parseInt(row.find('select[name="ShowType_' + roomId + '"]').val()) };
        $.post('@Url.Action("SaveRoomCamera","IDogCam")', data).done(function (response) {
            if (response.success) {
                showMessage('success', response.message);
                setTimeout(function () { location.reload(); }, 1000);
            } else {
                showMessage('error', response.message);
            }
        }).fail(function () { showMessage('error', 'Failed to save room camera configuration'); });
    });
});

    function onCredentialsSaved(response)
    {
        if (response.success)
        {
            showMessage('success', response.message);
            if (response.cameras && response.cameras.length > 0)
            {
                $('.camera-select').each(function () {
                    var currentValue = $(this).val();
                    $(this).empty().append('<option value="">Select Camera</option>');
                    $.each(response.cameras, function (i, camera) {
                        $(this).append('<option value="' + camera.Id + '">' + camera.Title + '</option>');
                    }.bind(this));
                    $(this).val(currentValue);
                });
            }
        }
        else
        {
            showMessage('error', response.message);
        }
    }
    function onCredentialsError() {
        showMessage('error', 'Failed to save credentials');
    }
    function showMessage(type, message) {
        var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        var messageHtml = '<div class="alert ' + alertClass + ' alert-dismissible"><button type="button" class="close" data-dismiss="alert">&times;</button>' + message + '</div>'; $('#credentials-status').html(messageHtml); if (type === 'success') { setTimeout(function () { $('.alert-success').fadeOut(); }, 3000); }
    }

</script>
}
