@model KCBase.IDogCam.Models.CameraViewerViewModel
@{ViewBag.Title="Camera Viewer - "+Model.CameraTitle;Layout="~/Views/Shared/_Layout.cshtml";}
<div class="camera-viewer">
    <div class="viewer-header">
        <h2>@Model.CameraTitle</h2>
        <div class="viewer-info">            
        </div>
    </div>
    <div class="viewer-content">
        @if(Model.CanView){
        <div class="camera-container">
            <div class="camera-frame">
                <div class="camera-placeholder">
                    <div class="placeholder-content">
                        <h3>🎥 Camera Ready</h3>
                        <p>Click below to open the camera feed in a popup window.</p>
                        <form id="cameraForm" action="https://idogcam.com/idogcamviewer.php?id=@Model.CameraId" method="post" enctype="multipart/form-data" style="display: inline-block;">
                            <input type="hidden" name="idogcamauth" value="@Model.Auth"/>
                            <input type="submit" class="btn btn-primary btn-lg" value="View Camera Feed" onclick="openCameraPopup(); return false;"/>
                        </form>
                    </div>
                </div>
            </div>
            <div class="camera-controls">
                <button type="button" class="btn btn-primary btn-sm" onclick="openCameraPopup()"><i class="icon-refresh"></i> Open Camera</button>
               <a href="@Url.Action("Setup","IDogCam")" class="btn btn-secondary btn-sm"><i class="icon-settings"></i> Camera Settings</a>
                <button type="button" class="btn btn-info btn-sm" onclick="openCameraPopup()"><i class="icon-external"></i> View in Popup</button>
            </div>
        </div>
        <div class="camera-info">
            <div class="info-card">
                <h4>Camera Information</h4>
                <div class="info-row"><span class="info-label">Camera ID:</span><span class="info-value">@Model.CameraId</span></div>
                <div class="info-row"><span class="info-label">Camera Name:</span><span class="info-value">@Model.CameraTitle</span></div>
                <div class="info-row"><span class="info-label">Last Updated:</span><span class="info-value" id="lastUpdated">@DateTime.Now.ToString("HH:mm:ss")</span></div>
            </div>
        </div>
        }else{
        <div class="access-denied">
            <div class="denied-icon">🚫</div>
            <h3>Camera Access Denied</h3>
            <p class="denied-reason">@Model.ReasonNotAvailable</p>            
            <div class="employee-debug">
                <h4>Debug Information (Employee View)</h4>
                <div class="debug-info">
                    <strong>Reason:</strong> @Model.ReasonNotAvailable<br/>
                    <strong>Camera ID:</strong> @Model.CameraId<br/>
                </div>
                <a href="@Url.Action("Setup","IDogCam")" class="btn btn-primary">Check Camera Configuration</a>
            </div>
        </div>
        }
    </div>
</div>

@section Scripts{
<script>
var refreshInterval;

$(document).ready(function(){
    refreshInterval = setInterval(function(){
        $('#lastUpdated').text(new Date().toLocaleTimeString());
    }, 60000);
    
    $('#lastUpdated').text(new Date().toLocaleTimeString());
});

function openCameraPopup() {
    var form = document.getElementById('cameraForm');
    if (form) {
        // Open popup window first
        var popup = window.open(
            'about:blank', 
            'CameraViewer', 
            'toolbar=0,scrollbars=1,location=0,statusbar=0,menubar=0,resizable=1,width=800,height=600'
        );
        
        if (popup) {
            // Set form target to the popup and submit
            form.target = 'CameraViewer';
            form.submit();
            popup.focus();
            $('#lastUpdated').text(new Date().toLocaleTimeString());
        } else {
            alert('Popup blocked! Please allow popups for this site and try again.');
        }
    }
}

function refreshCamera() {
    // Just reopen the camera popup
    openCameraPopup();
}

function toggleFullscreen() {
    // Since we're using popups, this just reopens the camera
    openCameraPopup();
}

$(window).on('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
}

<style>
.camera-viewer{max-width:1200px;margin:0 auto;padding:20px;font-family:Arial,sans-serif}.viewer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding:20px;background:#f8f9fa;border-radius:8px;border-left:4px solid #007bff}.viewer-header h2{color:#2c3e50;margin:0}.viewer-info{display:flex;gap:10px}.badge{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:bold;text-transform:uppercase;letter-spacing:0.5px}.badge-employee{background-color:#28a745;color:white}.badge-client{background-color:#007bff;color:white}.viewer-content{display:grid;grid-template-columns:2fr 1fr;gap:25px}@@media(max-width:768px){.viewer-content{grid-template-columns:1fr}}.camera-container{background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden}.camera-frame{position:relative;background:#000;min-height:400px}
    .camera-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 450px;
        background: linear-gradient(90deg, #1e5f74 0%, #4a9eff 50%, #7bc142 100%);
        color: white;
        text-align: center
    }.placeholder-content h3{margin-bottom:15px;font-size:24px}.placeholder-content p{margin-bottom:20px;opacity:0.9}.btn-lg{padding:12px 24px;font-size:16px}.icon-external::before{content:"🔗 "}.camera-iframe{width:100%;height:450px;border:none;display:block}.camera-controls{padding:15px;background:#f8f9fa;border-top:1px solid #dee2e6;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}.camera-info{align-self:start}.info-card{background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);padding:20px}.info-card h4{color:#2c3e50;margin-bottom:15px;border-bottom:2px solid #ecf0f1;padding-bottom:8px}.info-row{display:flex;justify-content:space-between;margin-bottom:10px;padding:5px 0}.info-label{font-weight:bold;color:#34495e}.info-value{color:#7f8c8d;text-align:right}.access-denied{grid-column:1/-1;text-align:center;padding:60px 20px;background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}.denied-icon{font-size:4em;margin-bottom:20px;opacity:0.7}.access-denied h3{color:#e74c3c;margin-bottom:15px}.denied-reason{color:#7f8c8d;font-size:16px;margin-bottom:30px;font-style:italic}.denied-help,.employee-debug{background:#f8f9fa;border-radius:8px;padding:20px;margin-top:25px;text-align:left;max-width:500px;margin-left:auto;margin-right:auto}.denied-help h4,.employee-debug h4{color:#2c3e50;margin-bottom:15px}.denied-help ul{text-align:left;color:#7f8c8d;margin-bottom:15px}.denied-help ul li{margin-bottom:5px}.debug-info{background:#e9ecef;padding:15px;border-radius:4px;font-family:monospace;margin-bottom:15px;line-height:1.6}.btn{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;text-decoration:none;display:inline-block;font-size:14px;transition:all 0.3s;text-align:center}.btn:hover{transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.2)}.btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}.btn-primary{background-color:#007bff;color:white}.btn-primary:hover:not(:disabled){background-color:#0056b3}.btn-secondary{background-color:#6c757d;color:white}.btn-secondary:hover{background-color:#545b62}.btn-info{background-color:#17a2b8;color:white}.btn-info:hover{background-color:#117a8b}.btn-sm{padding:6px 12px;font-size:13px}.icon-refresh::before{content:"🔄 "}.icon-external::before{content:"🔗 "}.icon-settings::before{content:"⚙️ "}.icon-loading::before{content:"⏳ "}@@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.icon-loading::before{animation:spin 1s linear infinite}
</style>