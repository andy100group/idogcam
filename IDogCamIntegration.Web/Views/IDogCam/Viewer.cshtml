@model KCBase.IDogCam.Models.CameraViewerViewModel
@{ViewBag.Title="Camera Viewer - "+Model.CameraTitle;Layout="~/Views/Shared/_Layout.cshtml";}
<div class="camera-viewer">
    <div class="viewer-header">
        <h2>@Model.CameraTitle</h2>
        <div class="viewer-info">            
        </div>
    </div>
    <div class="viewer-content">
        @if(Model.CanView){
        <div class="camera-container">
            <div class="camera-frame">
                <div class="camera-placeholder">
                    <div class="placeholder-content">
                        <h3>🎥 Camera Ready</h3>
                        <p>Click below to open the camera feed in a popup window.</p>
                        <form id="cameraForm" action="https://idogcam.com/idogcamviewer.php?id=@Model.CameraId" method="post" enctype="multipart/form-data" style="display: inline-block;">
                            <input type="hidden" name="idogcamauth" value="@Model.Auth"/>
                            <input type="submit" class="btn btn-primary btn-lg" value="View Camera Feed" onclick="openCameraPopup(); return false;"/>
                        </form>
                    </div>
                </div>
            </div>
            <div class="camera-controls">
                <button type="button" class="btn btn-primary btn-sm" onclick="openCameraPopup()"><i class="icon-refresh"></i> Open Camera</button>
               <a href="@Url.Action("Setup","IDogCam")" class="btn btn-secondary btn-sm"><i class="icon-settings"></i> Camera Settings</a>
                <button type="button" class="btn btn-info btn-sm" onclick="openCameraPopup()"><i class="icon-external"></i> View in Popup</button>
            </div>
        </div>
        <div class="camera-info">
            <div class="info-card">
                <h4>Camera Information</h4>
                <div class="info-row"><span class="info-label">Camera ID:</span><span class="info-value">@Model.CameraId</span></div>
                <div class="info-row"><span class="info-label">Camera Name:</span><span class="info-value">@Model.CameraTitle</span></div>
                <div class="info-row"><span class="info-label">Last Updated:</span><span class="info-value" id="lastUpdated">@DateTime.Now.ToString("HH:mm:ss")</span></div>
            </div>
        </div>
        }else{
        <div class="access-denied">
            <div class="denied-icon">🚫</div>
            <h3>Camera Access Denied</h3>
            <p class="denied-reason">@Model.ReasonNotAvailable</p>            
            <div class="employee-debug">
                <h4>Debug Information (Employee View)</h4>
                <div class="debug-info">
                    <strong>Reason:</strong> @Model.ReasonNotAvailable<br/>
                    <strong>Camera ID:</strong> @Model.CameraId<br/>
                </div>
                <a href="@Url.Action("Setup","IDogCam")" class="btn btn-primary">Check Camera Configuration</a>
            </div>
        </div>
        }
    </div>
</div>

@section Scripts{
<script>
var refreshInterval;

$(document).ready(function(){
    refreshInterval = setInterval(function(){
        $('#lastUpdated').text(new Date().toLocaleTimeString());
    }, 60000);
    
    $('#lastUpdated').text(new Date().toLocaleTimeString());
});

function openCameraPopup() {
    var form = document.getElementById('cameraForm');
    if (form) {
        // Open popup window first
        var popup = window.open(
            'about:blank', 
            'CameraViewer', 
            'toolbar=0,scrollbars=1,location=0,statusbar=0,menubar=0,resizable=1,width=800,height=600'
        );
        
        if (popup) {
            // Set form target to the popup and submit
            form.target = 'CameraViewer';
            form.submit();
            popup.focus();
            $('#lastUpdated').text(new Date().toLocaleTimeString());
        } else {
            alert('Popup blocked! Please allow popups for this site and try again.');
        }
    }
}

function refreshCamera() {
    // Just reopen the camera popup
    openCameraPopup();
}

function toggleFullscreen() {
    // Since we're using popups, this just reopens the camera
    openCameraPopup();
}

$(window).on('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
}
